## MBR使用硬盘

操作硬盘是通过操作硬盘控制器来操作硬盘的，硬盘控制器属于I/O接口，通过读写硬盘控制器的不同端口，端口就是位于接口里面的寄存器。

### 1. 硬盘的结构

#### 1.1 CHS表示法

对于古老的机械硬盘，结构如下所示：

<img width="50%" src="https://i.loli.net/2021/04/19/swMPfudAhnJvWKt.png"/>

<p style="text-align:right">图片来源：《操作系统真象还原》</p>

机械硬盘就是多个盘片，通过磁头读取盘片的数据。

每一个盘面都有对应一个**磁头**，如图紫色部分，用于读取数据。磁头从0开始编号。

一个盘面上分成了很多同心圆组成的环，这些环就叫**磁道**。如上图红色、绿色的圆环。磁道从0开始编号，并且仅限本盘面内有效。

上下盘片，相同磁道号的圆环，组成**柱面**，如图上下两个盘片的相同颜色的磁道是同一个柱面。

一个柱面又包含了多个**扇区**，扇区就是图中黑色扇形的区域。**扇区从1开始编号**，并且仅限本磁道内有效。**一个扇区是512字节**。



这种定位一块具体的扇区，叫CHS方法，C即柱面Cylinder，H即磁头Header，S即扇区Sector。

上面CHS方法是根据机械硬盘的物理结构来划分的不同部分，但是现在使用的大部分是固态硬盘、U盘，根本没有扇区、磁头、磁道之类的。但是CHS其实也是一种逻辑上的划分方式，其他硬盘也可以使用的。

#### 1.2 LBA表示法

上面定位硬盘中一个具体的位置，使用CHS的方法来定位一个扇区，从物理几何结构上看，这样表示十分直观。但是每次要访问某个扇区，都要经过计算得到CHS，十分麻烦。

因此有一种逻辑上更加简单的方式，就是把所有的扇区统一编址，不考虑硬盘的物理结构。这样的编址方式叫做LBA(Logical Block Address)。

LBA就是把所有扇区看成一个一维数组，从0开始编号，然后编号到最后一个扇区。

LBA有两种，一种是LBA28，使用28位来描述一个扇区的地址。最大寻址范围是2<sup>28</sup>个扇区，每个扇区是512字节，因此28位可以描述128GB的地址空间。另一种方式是LBA48，使用48位来描述一个扇区的地址。最大寻址范围是2<sup>48</sup>个扇区，可以描述14PB地址空间。

### 2. 硬盘控制器

硬盘有不同的物理结构，CPU直接操作硬盘是很复杂的，为了解除耦合性，硬盘都由一个硬盘控制器来控制，然后CPU通过控制硬盘控制器来间接控制硬盘。

硬盘和硬盘控制器通过接口整合在一起，这种接口叫做集成设备电路(Integrated Drive Electrons， IDE)，后来这种标准称为全球标准，叫做ATA(Advanced Technology Attachment)，但是现在还是习惯性叫做IDE。

ATA根据是否串行，分为串行接口SATA（Serial ATA）和并行接口PATA(Parallel ATA)。

根据是否并行，硬盘和硬盘控制器的接口可以分为下面两种：

![](https://i.loli.net/2021/04/20/G1bh2T73krELay5.png)

一般主板上有两个接口，这两个接口也有编号，一个叫IDE0，一个叫IDE1。如果按照ATA的说法，这两个接口叫做通道：Primary 通道和Secondary通道。

按照接口在主板的位置，也可以分为下面两个情况：

![](https://i.loli.net/2021/04/20/5tE319YKJMljqWc.png)

然后每个IDE接口（通道），都可以挂两个硬盘，一个叫主盘Master，一个叫从盘Slave。



**总结一下，主板有两个接口：IDE0（也叫Primary通道）和IDE1（也叫Secondary通道），每个接口（通道）都有两块硬盘，一个叫主盘Master，一个叫从盘Slave。**

### 3. 操作硬盘

要想使用软件的方式操作硬盘，该如何操作呢？

硬盘属于I/O设备，都是由**硬盘控制器**来控制的，硬盘控制器属于**I/O接口**，I/O接口中有多个**端口**，**端口起始就是接口中的寄存器**，每个寄存器中的每一位都表示不同的意思，我们**通过控制硬盘控制器中的端口（寄存器）的数值来实现控制硬盘的目的**。

#### 3.1 硬盘控制器

下面列出一些硬盘控制器中常用的寄存器：

![image-20210420212620650](https://i.loli.net/2021/04/20/rPq4ogKiJ5QSac6.png)

> 只有Data寄存器是16位的，其他都是8位的

也就是说，只要我往这些端口写入数据，就可以操作硬盘了。

对于每个端口的用途，看名字基本上也可以看出来了。



但有几个寄存器/端口要重点讲解下：

- Command寄存器（0x1F7 / 0x177端口）：
  - 该寄存器，顾名思义，表示命令。
  - 赋值为0x20表示我要读取<font color="red">硬盘</font>。（注意是硬盘，可不是读取寄存器）
  - 赋值为0x30表示我要往<font color="red">硬盘</font>中写入数据

- Device寄存器（0x1F6 / 0x176端口）
  - 该寄存器集合了好几个字段，不同的位有这不同的意义
  - 该寄存器的高4位(0-3位)是LBA的第23-27位，第4位用来表示主盘或者从盘，第6位，表示寻址方式LBA或者CHS
- Status寄存器（0x1F7 / 0x177端口）：
  - 该寄存器和Command寄存器在同一端口。
  - 当硬盘有数据准备好了，可以读取该寄存器，得到一些信息。

Device寄存器和Status寄存器的结构如下：

![image-20210525144229769](https://i.loli.net/2021/05/25/tYbfHiFWxRvuGdB.png)



#### 3.2 读取硬盘步骤

所以要想读取硬盘，大致如下几个步骤：

1. 设置要读取的扇区数目

   > 向```0x1f2``` 端口（Sector count寄存器）设置要读取的扇区数目

2. 设置LBA地址

   > LBA地址7~0位写入端口0x1f3（LBA low寄存器）
   >
   > LBA地址15~8位写入端口0x1f4（LBA mid寄存器）
   >
   > LBA地址23~16位写入端口0x1f5（LBA high寄存器）
   >
   > LBA地址24~27位写入端口0x1f6的低4位（Device寄存器）

3. 发送读命令

   > 向0x1f7端口（Command寄存器）写入读命令（0x20）
   >
   > 发送0x20表示读取命令，0x30表示写入命令

4. 开始从硬盘读取信息

   > 读取之前要先判断硬盘是否准备好，通过轮询0x1f7端口（Status寄存器）的最高位
   >
   > 准备好了，就从0x1f0端口（Data寄存器[16位]）中读取数据





