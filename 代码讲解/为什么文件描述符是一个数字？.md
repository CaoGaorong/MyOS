## 为什么文件描述符是一个数字？

如果使用系统调用函数```open```打开一个文件会得到一个文件描述符，可是为什么文件描述符是一个数字呢？凭借这个数字怎样定位到一个文件的呢？

文件描述符只是一个数字，不同的进程使用相同的文件描述符不会冲突吗？



在说清楚为什么文件描述符是数字之前，要先说一下几点：

- 磁盘中的文件如何描述
- 如何描述一个打开的文件

### 1. 如何描述磁盘中的文件

对于一个文件，有很多属性，比如大小、创建时间、存储在哪个扇区等等属性，都需要用一个结构来描述，这个结构就叫做```inode```，```inode```描述了一个文件的静态属性。

磁盘中存储了很多文件，就应该有很多的```inode```，组成了```inode```列表。

所以，我们创建一个文件、访问文件，通过操作该文件对应的```inode```。

```inode```的结构大致可以是这样的：

```c
struct inode
{
    uint32_t i_no; // inode编号
    uint32_t i_size; // 文件大小
    uint32_t i_open_cnts; // 记录此文件被打开的次数
    bool write_deny;      // 写文件不能并行,进程写文件前检查此标识

    /* i_sectors[0-11]是直接块, i_sectors[12]用来存储一级间接块指针 */
    uint32_t i_sectors[13]; // 表示该文件存储在哪个块中
    struct list_elem inode_tag; // 这里把多个inode可以添加到队列，串起来
};
```

硬盘中有很多文件，就会有很多的```inode```，就有一个```inode```链表。

### 2. 如何描述一个打开的文件

对于同一个文件，我们可以打开多次，并且可以打开在不同的位置（比如文件打开的偏移量不同），可以有不同的权限打开（比如只读）。

这种“动态”的文件属性，描述了一个打开的文件，也应该有一个结构来描述，这个结构就叫文件结构。

文件结构可以是这样的：

```c
struct file
{
    uint32_t fd_pos; // 记录当前文件操作的偏移地址
    uint32_t fd_flag; // 该操作文件的标志，是创建文件？还是只读？还是写入？
    struct inode *fd_inode; // 操作的文件对应的inode
};
```

很多文件被打开，就会有很多的```file```结构，就组成了```file_table```：

```c
struct file file_table[MAX_FILE_OPEN]; // 最多有MAX_FILE_OPEN个文件结构，也就是系统最多打开MAX_FILE_OPEN个文件
```

这个文件表```file_table```是由操作系统统一管理，所有进程共用一个```file_table```。

**所以，只要得到了文件表```file_table```的下标，就可以得到文件结构了，就可以管理一个打开的文件了**。



### 3. 文件描述符

打开一个文件，是由某个**进程**打开的，一个进程也可以打开多个文件，所以**一个进程应该有多个文件描述符**。

所以每个进程管理各自打开的文件，应该互相独立，所以应该单独维护了一个文件描述符表：

```c
struct task_struct {
	//......
  	int fd_table[MAX_FILES_OPEN_PER_PROC];// 一个进程最多打开MAX_FILES_OPEN_PER_PROC个文件
}
```

所以，当打开文件open时，得到的数字，就是文件描述符表的下标。

### 4. 文件描述符和文件的联系

有了上述的讲解，就可以建立文件描述符和文件的联系了。首先回顾下 上面讲的几个概念：

- ```inode```：描述文件的静态属性，比如创建时间、大小等信息
- 文件结构：描述一个打开的文件，比如文件偏移量、文件操作标志、文件对应的```inode```
- 文件描述符：不同进程之间独立，对应一个文件结构。



他们之间的关系如下图：

![文件描述符表和文件结构表和inode表](https://gitee.com/imcgr/image_blog/raw/master/20210621143105.png)

也就解释了为什么文件描述符是一个数字，通过该数字又是如何访问到打开的文件的：

- 访问文件描述符表
  - 该数字，比如数字1，就是文件描述符表```fd_table```的下标
  - 通过该下标，会去访问```fd_table[1]```，得到文件描述符表项
  - 文件描述符表项存储的是文件结构表的下标
- 访问文件结构表
  - 根据文件描述符表项，得到文件结构表下标
  - 根据文件结构表下标，得到文件结构表中的```inode```指针
- 访问```inode```
  - 根据文件结构表的```inode```指针，可以访问到```inode```
- 访问磁盘上的文件
  - 磁盘中的文件是由```inode```描述的，所以根据```inode```可以访问到具体的文件



<font color="red"><b>文件描述符就是文件描述符表的下标，所以是一个数字。</b></font>

